<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,
    maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <link href='http://www.openhiun.com/hangul/nanumbarungothic.css' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" th:href="@{/css/base.css}" />
    <link rel="stylesheet" th:href="@{/css/board/semanticBoardDetail.css}" />
    <link rel="stylesheet" th:href="@{/css/semantic.min.css}" />
    <title th:text="${board?.title}"> </title>
    <meta name="description" content="게임을 이용하는 유저들의 만남의 장이 될 수 있게
    매칭 시스템, 커뮤니티 등을 제공합니다.">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Game Duos-글 작성">
    <meta property="og:description" content="눈치 볼 필요없이 게임 같이 할 사람 구하자!">
    <meta property="og:image" content="http://">
    <meta property="og:url" content="https://GameDuos.com">
</head>
<body>
<!--header-->
<!--body-->
<div th:replace="layout/header::header"></div>
<!-- middle area -->
<div class="middle-area-container">
    <section class="sec1">
        <div class="intro"></div>
    </section>
    <section class="sec2">
        <div class="left-banner-wrapper">
            <div class="left-banner">
            </div>
        </div>
        <div class="boardContainer">
            <div id="mainHide">
                <div class="ui raised segment">
                    <div class="article">
                        <div class="article-header">
                            <div class="article-title">
                                <h1 id="board_title" th:text="${board?.title}"></h1>
                            </div>
                            <div class="article-meta">
                                <div class="article-meta-left">
                                    <div class="article-meta-item">
                                        <i class="user outline icon"></i>
                                        <span th:text="${boardUser.getNickName()}"></span>
                                    </div>
                                    <div class="divider"> / </div>
                                    <div class="article-meta-item">
                                        <i class="calendar outline icon"></i>
                                        <span id="article_date" th:text="${board?.createdDate}"></span>
                                    </div>
                                    <div class="divider"> / </div>
                                    <div class="article-meta-item">
                                        <i class="folder open outline icon"></i>
                                        <span id="article_type" th:text="${board?.boardType.value}"></span>
                                        &nbsp
                                        <span id="board_idx" th:text="${board?.idx}"></span>
                                    </div>
                                </div>
                                <div class="article-meta-right">
                                    <div class="article-meta-item">
                                        <i class="comment outline icon"></i>
                                        <span th:text="${commentInfoList.size()}"></span>
                                    </div>
                                    <div class="divider"> / </div>
                                    <div class="article-meta-item">
                                        <i class="heart outline icon"></i>
                                        <span th:text="${board.getLikesCnt()}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="ui divider"></div>
                        <div class="article-content-wrap">
                            <div class="article-content" id="board_content" th:utext="${board?.content}"></div>
                        </div>
                        <div class="article-vote-box">
                            <div class="vote">
                                <div class="ui labeled button" tabindex="0">
                                    <div class="ui button" id="like">
                                        <i class="heart icon"></i> <span>좋아요</span>
                                    </div>
                                    <a class="ui basic label">
                                        <span th:text="${board.getLikesCnt()}"></span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="article-footer">
                            <div class="article-footer-report">
                                <div class="article-footer-report-item">
                                    <span id="postReport"><i class="shield alternate icon"></i>신고하기</span>
                                    <a th:if="${boardUser.getId()} == ${session.user.id}" th:href="'/board/editForm?idx='+${board.getIdx()}"><i class="edit outline icon"></i>수정하기</a>
                                </div>
                            </div>
                            <div class="article-footer-back">
                                <div class="ui animated button" tabindex="0" onclick="pageBack()">
                                    <div class="visible content">목록으로</div>
                                    <div class="hidden content">
                                        <i class="left arrow icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Comments-->
                    <div class="ui divider"></div>
                    <div class="comments-container">
                        <div class="ui comments">
                            <h3 class="ui dividing header">댓글</h3>
                            <div class="comment" th:each="commentInfo : ${commentInfoList}">
                                <a class="avatar">
                                    <img src="https://place-hold.it/35x35">
                                </a>
                                <div class="content">
                                    <a class="author" th:href="'/board?idx='+${commentInfo.getCommentUserNickname()}" th:text="${commentInfo.getCommentUserNickname()}">닉넴</a>
                                    <div class="metadata">
                                        <input type="hidden" class="comment_id" th:value="${commentInfo.getComment().getId()}" />
                                        <span class="date" th:text="${commentInfo.getComment().getCreatedDate()} ? ${#temporals.format(commentInfo.getComment().getCreatedDate(),'yyyy-MM-dd HH:mm')} : ${commentInfo.getComment().getCreatedDate()}"></span>
                                        <div id="commentRating">
                                            <i class="star icon"></i>
                                        </div>
                                        <span th:if="${commentInfo.getComment().getUpdated() == 1}">(수정됨)</span>
                                    </div>s
                                    <div class="text" th:if="${commentInfo.getComment().getDeleted() == 0}" th:text="${commentInfo.getComment().getContent()}"></div>
                                    <div class="text" th:if="${commentInfo.getComment().getDeleted() == 1}" style="color: darkgray ">
                                        <i class="trash alternate outline icon"></i> 삭제된 댓글입니다.
                                    </div>
                                    <div class="actions">
                                        <a th:if="${commentInfo.getComment().getDeleted() == 0}" class="reply">답글 달기</a>
                                        <a th:if="${commentInfo.getComment().getDeleted() == 0}" class="comment-report">신고하기</a>
                                        <a th:if="${commentInfo.getCommentUserId()} == ${session.user.id} and ${commentInfo.getComment().getDeleted() == 0}" class="edit">수정</a>
                                        <a th:if="${commentInfo.getCommentUserId()} == ${session.user.id} and ${commentInfo.getComment().getDeleted() == 0}" class="delete">삭제</a>
                                    </div>
                                </div>
                            </div>
                            <form class="ui reply form">
                                <div class="field">
                                    <textarea id="comment_content"></textarea>
                                </div>
                                <div class="ui blue labeled submit icon button" id="comment_insert">
                                    <i class="icon edit"></i> 댓글 달기
                                </div>
                                <div class="comments-refresh">
                                    <span id="commentsRefresh"><i class="sync alternate icon"></i>댓글 새로고침</span>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="to-the-up">
                    <div class="ui vertical animated button" tabindex="0" onclick="window.scrollTo(0,0);">
                        <div class="hidden content">맨 위로</div>
                        <div class="visible content">
                            <i class="arrow up icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="right-banner-wrapper">
            <div class="ui wide skyscraper test ad" data-text="Skyscraper"></div>
        </div>
    </section>
</div>
<!-- modal -->
<div class="ui mini modal">
        <div class="header">
            댓글 삭제하기
        </div>
        <div class="content">
            <p>댓글을 삭제하여도 댓글을 작성한 흔적은 남습니다.</p>
            <p>해당 댓글을 삭제하시겠습니까?</p>
        </div>
        <div class="actions">
            <div class="ui cancel button">취소</div>
            <div class="negative ui approve button" id="comment_delete">삭제</div>
        </div>
</div>
<div th:replace="layout/footer::footer"></div>

<script th:src="@{/js/jquery.min.js}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.3/semantic.min.js"></script>
<script>
    //서버에서 데이터만(json)만 받아서 직접 js로 만지고싶은데....
    // 구조가 서버사이드 렌더링이라 강제로 model에 저장되어있는 데이터를 끄집어내겠다,,,
    console.log("서버에서 데이터만(json)만 받아서 직접 js로 만지고싶은데....\n" +
        "     애초에 시작한 구조가 서버사이드 렌더링이라..\n" +
        "백엔드와 프론트엔드를 떼어낼 그 날을 위하여...ㅠㅠ");
</script>
<script>
    var articleDateText = document.getElementById("article_date").innerText;

    window.onload = function(){
        articleDateSpliter(articleDateText);
    }
    articleDateSpliter(articleDateText);

    function articleDateSpliter(str) {
        var strArr = str.split('');
        var slicedStrArr = strArr.slice(0,10);
        var text = slicedStrArr.join('');

        document.getElementById("article_date").innerHTML = text;
    }

    function pageBack() {
        history.back();
    }
</script>

<script>
    $('.edit').on('click', function () {
        var commentId = $(this).parent().parent().find('.metadata').find('input:hidden').val();
        var commentActionDiv = $(this).parent();
        var commentContentDiv = $(this).parent().prev();
        var commentContent = commentContentDiv.text();

        var form = createCommentEditForm(commentContent);
        $(commentContentDiv).after(form);
        commentContentDiv.hide();
        commentActionDiv.hide();
    });

    function createCommentEditForm(content) {
        var form = document.createElement('form');
        var fieldDiv = document.createElement('div');
        var textarea = document.createElement('textarea');
        var submitDiv = document.createElement('div');
        var cancleDiv = document.createElement('div');

        form.className = 'ui reply form';
        fieldDiv.className = 'field';
        textarea.value = content;
        submitDiv.className = 'ui green button commentUpdate';
        submitDiv.innerHTML = '수정'
        cancleDiv.className = 'ui button commentEditCancle';
        cancleDiv.innerHTML = '취소';

        cancleDiv.onclick = function (event) {
            var editForm = $(this).parent().parent();
            var commentForm = $(this).parent().parent().parent().find('.text');
            var commentActions = $(this).parent().parent().parent().find('.actions');
            commentForm.show();
            commentActions.show();
            editForm.remove();
        }

        submitDiv.onclick = function (event) {

                var textareaContent = $(this).parent().find('textarea').val();
                var commentId = $(this).parent().parent().prev().prev().find('.comment_id').val();

                var jsonData = JSON.stringify({
                    commentId: commentId,
                    content: textareaContent,
                    boardIdx: $('#board_idx').val()
                });
                $.ajax({
                    url: "http://localhost:8080/api/comments/" + commentId,
                    type: "PUT",
                    data: jsonData,
                    contentType: "application/json",
                    dataType: "json",
                    success: function (data, status) {
                        location.reload();
                        console.log('댓글 수정 성공! data >>>' + data + "status >> " + status);
                    },
                    error: function (status) {
                        console.log('댓글 수정 실패!' + status);
                    }
                });
        }

        fieldDiv.appendChild(textarea);
        fieldDiv.appendChild(submitDiv);
        fieldDiv.appendChild(cancleDiv);
        form.appendChild(fieldDiv);

        textarea.focus();
        return form;
    }
</script>
<script>
    $('.delete').on('click', function () {
        var commentId = $(this).parent().parent().find('.metadata').find('input:hidden').val();

        $('.mini.modal')
            .modal({
                allowMultiple: false,
                blurring: true,
                onApprove: function () {
                    $.ajax({
                        url: "http://localhost:8080/api/comments/" + commentId,
                        type: "DELETE",
                        success: function (data,status) {
                            location.reload();
                            console.log('삭제 성공!' + 'data >> ' + data + 'status >> ' + status);
                        },
                        error: function (status) {
                            alert('삭제 실패!' + 'status >> ' + status);
                        }
                    });
                }
            })
            .modal('show');
    });
</script>
<script>
    $('#like').click(function () {
        var jsonData = JSON.stringify({
            boardIdx: $('#board_idx').text()
        });
        $.ajax({
            url: "http://localhost:8080/api/likes/board",
            type: "POST",
            data: jsonData,
            contentType: "application/json",
            dataType: "json",
            success: function () {
                alert('추천 성공!');
                location.reload();
            },
            error: function () {
                location.reload();
            }
        });
    });
</script>
<script>
    $('#comment_insert').click(function () {
        var jsonData = JSON.stringify({
            content: $('#comment_content').val(),
            boardIdx: $('#board_idx').text()
            });
        $.ajax({
            url: "http://localhost:8080/api/comments",
            type: "POST",
            data: jsonData,
            contentType: "application/json",
            dataType: "json",
            success: function (data,status) {
                console.log('댓글 저장 성공! data >>>' + data + "status >> "  + status);
                location.reload();
            },
            error: function (status) {
                console.log('댓글 저장 실패!' + status);
            }
        });
    });

</script>
